<!DOCTYPE html>
<html lang="en" prefix="og: http://ogp.me/ns# fb: https://www.facebook.com/2008/fbml">
<head>
    <title>Serve tensorflow iris models - Water Developer</title>
    <!-- Using the latest rendering mode for IE -->
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">



<link rel="canonical" href="./serve-tensorflow-iris-models.html">

        <meta name="author" content="Hyunmin" />
        <meta name="keywords" content="SignatureDef,iris" />
        <meta name="description" content="Export a model # Feature columns describe how to use the input. my_feature_columns = [] for key in train_x.keys(): my_feature_columns.append(tf.feature_column.numeric_column(key=key)) feature_spec = tf.feature_column.make_parse_example_spec(my_feature_columns) serving_input_receiver_fn = tf.estimator.export.build_parsing_serving_input_receiver_fn(feature_spec) export_dir = classifier.export_savedmodel(&#39;export&#39;, serving_input_receiver_fn) or def serving_input_receiver_fn(): max_seq_length = FLAGS.max_seq_length batch_size = 1 feature_spec = { &#34;unique_ids …" />

        <meta property="og:site_name" content="Water Developer" />
        <meta property="og:type" content="article"/>
        <meta property="og:title" content="Serve tensorflow iris models"/>
        <meta property="og:url" content="./serve-tensorflow-iris-models.html"/>
        <meta property="og:description" content="Export a model # Feature columns describe how to use the input. my_feature_columns = [] for key in train_x.keys(): my_feature_columns.append(tf.feature_column.numeric_column(key=key)) feature_spec = tf.feature_column.make_parse_example_spec(my_feature_columns) serving_input_receiver_fn = tf.estimator.export.build_parsing_serving_input_receiver_fn(feature_spec) export_dir = classifier.export_savedmodel(&#39;export&#39;, serving_input_receiver_fn) or def serving_input_receiver_fn(): max_seq_length = FLAGS.max_seq_length batch_size = 1 feature_spec = { &#34;unique_ids …"/>
        <meta property="article:published_time" content="2019-09-09" />
            <meta property="article:section" content="misc" />
            <meta property="article:tag" content="SignatureDef" />
            <meta property="article:tag" content="iris" />
            <meta property="article:author" content="Hyunmin" />



    <!-- Bootstrap -->
        <link rel="stylesheet" href="./theme/css/bootstrap.min.css" type="text/css"/>
    <link href="./theme/css/font-awesome.min.css" rel="stylesheet">

    <link href="./theme/css/pygments/native.css" rel="stylesheet">
    <link href="./theme/tipuesearch/tipuesearch.css" rel="stylesheet">
    <link rel="stylesheet" href="./theme/css/style.css" type="text/css"/>





</head>
<body>

<div class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="container">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-ex1-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a href="./" class="navbar-brand">
Water Developer            </a>
        </div>
        <div class="collapse navbar-collapse navbar-ex1-collapse">
            <ul class="nav navbar-nav">
                        <li >
                            <a href="./category/dev.html">Dev</a>
                        </li>
                        <li class="active">
                            <a href="./category/misc.html">Misc</a>
                        </li>
                        <li >
                            <a href="./category/munjang.html">문장</a>
                        </li>
                        <li >
                            <a href="./category/sebasi.html">세바시</a>
                        </li>
            </ul>
            <ul class="nav navbar-nav navbar-right">
              <li><span>
                <form class="navbar-search" action="/search.html">
                  <input type="text" class="search-query" placeholder="Search" name="q" id="tipue_search_input" required>
                </form></span>
              </li>
            </ul>
        </div>
        <!-- /.navbar-collapse -->
    </div>
</div> <!-- /.navbar -->

<!-- Banner -->
<!-- End Banner -->

<!-- Content Container -->
<div class="container">
    <div class="row">
        <div class="col-sm-9">
    <section id="content">
        <article>
            <header class="page-header">
                <h1>
                    <a href="./serve-tensorflow-iris-models.html"
                       rel="bookmark"
                       title="Permalink to Serve tensorflow iris models">
                        Serve tensorflow iris models
                    </a>
                </h1>
            </header>
            <div class="entry-content">
                <div class="panel">
                    <div class="panel-body">
<footer class="post-info">
    <span class="label label-default">Date</span>
    <span class="published">
        <i class="fa fa-calendar"></i><time datetime="2019-09-09T14:49:00+09:00"> Mon 09 September 2019</time>
    </span>





<span class="label label-default">Tags</span>
	<a href="./tag/signaturedef.html">SignatureDef</a>
        /
	<a href="./tag/iris.html">iris</a>
    
</footer><!-- /.post-info -->                    </div>
                </div>
                <h3>Export a model</h3>
<div class="highlight"><pre><span></span>    <span class="c1"># Feature columns describe how to use the input.</span>
    <span class="n">my_feature_columns</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">train_x</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">my_feature_columns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">feature_column</span><span class="o">.</span><span class="n">numeric_column</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">key</span><span class="p">))</span>

    <span class="n">feature_spec</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">feature_column</span><span class="o">.</span><span class="n">make_parse_example_spec</span><span class="p">(</span><span class="n">my_feature_columns</span><span class="p">)</span>
    <span class="n">serving_input_receiver_fn</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">estimator</span><span class="o">.</span><span class="n">export</span><span class="o">.</span><span class="n">build_parsing_serving_input_receiver_fn</span><span class="p">(</span><span class="n">feature_spec</span><span class="p">)</span>
    <span class="n">export_dir</span> <span class="o">=</span> <span class="n">classifier</span><span class="o">.</span><span class="n">export_savedmodel</span><span class="p">(</span><span class="s1">&#39;export&#39;</span><span class="p">,</span> <span class="n">serving_input_receiver_fn</span><span class="p">)</span>
</pre></div>


<p>or </p>
<div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">serving_input_receiver_fn</span><span class="p">():</span>
  <span class="n">max_seq_length</span> <span class="o">=</span> <span class="n">FLAGS</span><span class="o">.</span><span class="n">max_seq_length</span>
  <span class="n">batch_size</span> <span class="o">=</span> <span class="mi">1</span>
  <span class="n">feature_spec</span> <span class="o">=</span> <span class="p">{</span>
  <span class="s2">&quot;unique_ids&quot;</span><span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">FixedLenFeature</span><span class="p">([],</span> <span class="n">tf</span><span class="o">.</span><span class="n">int64</span><span class="p">),</span>
  <span class="s2">&quot;input_ids&quot;</span><span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">FixedLenFeature</span><span class="p">([</span><span class="n">max_seq_length</span><span class="p">],</span> <span class="n">tf</span><span class="o">.</span><span class="n">int64</span><span class="p">),</span>
  <span class="s2">&quot;input_mask&quot;</span><span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">FixedLenFeature</span><span class="p">([</span><span class="n">max_seq_length</span><span class="p">],</span> <span class="n">tf</span><span class="o">.</span><span class="n">int64</span><span class="p">),</span>
  <span class="s2">&quot;segment_ids&quot;</span><span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">FixedLenFeature</span><span class="p">([</span><span class="n">max_seq_length</span><span class="p">],</span> <span class="n">tf</span><span class="o">.</span><span class="n">int64</span><span class="p">),</span>
        <span class="p">}</span>

  <span class="n">serialized_tf_example</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">placeholder</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">string</span><span class="p">,</span>
                                         <span class="n">shape</span><span class="o">=</span><span class="p">[</span><span class="n">batch_size</span><span class="p">],</span>
                                         <span class="n">name</span><span class="o">=</span><span class="s1">&#39;input_example_tensor&#39;</span><span class="p">)</span>
  <span class="n">receiver_tensors</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;examples&#39;</span><span class="p">:</span> <span class="n">serialized_tf_example</span><span class="p">}</span>
  <span class="n">features</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">parse_example</span><span class="p">(</span><span class="n">serialized_tf_example</span><span class="p">,</span> <span class="n">feature_spec</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">tf</span><span class="o">.</span><span class="n">estimator</span><span class="o">.</span><span class="n">export</span><span class="o">.</span><span class="n">ServingInputReceiver</span><span class="p">(</span><span class="n">features</span><span class="p">,</span> <span class="n">receiver_tensors</span><span class="p">)</span>

  <span class="o">..</span>
  <span class="o">..</span>

  <span class="n">estimator</span><span class="o">.</span><span class="n">export_saved_model</span><span class="p">(</span>
        <span class="n">export_dir_base</span><span class="o">=</span><span class="n">EXPORT_PATH</span><span class="p">,</span>
        <span class="n">serving_input_receiver_fn</span><span class="o">=</span><span class="n">serving_input_receiver_fn</span><span class="p">)</span>
</pre></div>


<h3>saved_model_cli 를 이용해 모델의 입/출력을 확인하자.</h3>
<div class="highlight"><pre><span></span>$ saved_model_cli show --dir export/1568007663 --tag_set serve  --signature_def serving_default

The given SavedModel SignatureDef contains the following input<span class="o">(</span>s<span class="o">)</span>:
  inputs<span class="o">[</span><span class="s1">&#39;inputs&#39;</span><span class="o">]</span> tensor_info:
      dtype: DT_STRING
      shape: <span class="o">(</span>-1<span class="o">)</span>
      name: input_example_tensor:0
The given SavedModel SignatureDef contains the following output<span class="o">(</span>s<span class="o">)</span>:
  outputs<span class="o">[</span><span class="s1">&#39;classes&#39;</span><span class="o">]</span> tensor_info:
      dtype: DT_STRING
      shape: <span class="o">(</span>-1, <span class="m">3</span><span class="o">)</span>
      name: dnn/head/Tile:0
  outputs<span class="o">[</span><span class="s1">&#39;scores&#39;</span><span class="o">]</span> tensor_info:
      dtype: DT_FLOAT
      shape: <span class="o">(</span>-1, <span class="m">3</span><span class="o">)</span>
      name: dnn/head/predictions/probabilities:0
Method name is: tensorflow/serving/classify
</pre></div>


<ul>
<li>
<p>Serve TensforFlow Estimator with SavedModel
<a href="http://shzhangji.com/blog/2018/05/14/serve-tensorflow-estimator-with-savedmodel/">http://shzhangji.com/blog/2018/05/14/serve-tensorflow-estimator-with-savedmodel/</a></p>
</li>
<li>
<p>How to export tf.learn.DNNClassifier model for serving? #488
<a href="https://github.com/tensorflow/tensorflow/issues/12508#issuecomment-325422910">https://github.com/tensorflow/tensorflow/issues/12508#issuecomment-325422910</a></p>
</li>
</ul>
<h3>How to run it as a server</h3>
<div class="highlight"><pre><span></span>$ tensorflow_model_server --rest_api_port<span class="o">=</span><span class="m">8501</span> --model_name<span class="o">=</span>iris --model_base_path<span class="o">=</span>/home/hm_home/work/anything/ml/iris/export
</pre></div>


<ul>
<li>8500: gRPC</li>
<li>8501: rest api</li>
</ul>
<h3>How to test it as a client</h3>
<p>/tmp/temp.json</p>
<div class="highlight"><pre><span></span>[{&quot;SepalLength&quot;:[5.1],&quot;SepalWidth&quot;:[3.3],&quot;PetalLength&quot;:[1.7],&quot;PetalWidth&quot;:[0.5]}]
</pre></div>


<div class="highlight"><pre><span></span>$ curl -X POST http://localhost:8501/v1/models/iris:classify  -H <span class="s2">&quot;Content-Type: application/json&quot;</span> -d @/tmp/temp.json
</pre></div>
            </div>
            <!-- /.entry-content -->
        </article>
    </section>

        </div>
        <div class="col-sm-3" id="sidebar">
            <aside>
<!-- Sidebar -->
<section class="well well-sm">
  <ul class="list-group list-group-flush">

<!-- Sidebar/Social -->
<li class="list-group-item">
  <h4><i class="fa fa-home fa-lg"></i><span class="icon-label">Social</span></h4>
  <ul class="list-group" id="social">
    <li class="list-group-item"><a href="https://github.com/harry81"><i class="fa fa-github-square fa-lg"></i> Github</a></li>
  </ul>
</li>
<!-- End Sidebar/Social -->

<!-- Sidebar/Links -->
<li class="list-group-item">
  <h4><i class="fa fa-external-link-square fa-lg"></i><span class="icon-label">Links</span></h4>
  <ul class="list-group" id="links">
    <li class="list-group-item">
      <a href="http://getpelican.com/" target="_blank">Pelican</a>
    </li>
  </ul>
</li>
<!-- End Sidebar/Links -->
  </ul>
</section>
<!-- End Sidebar -->            </aside>
        </div>
    </div>
</div>
<!-- End Content Container -->

<footer>
   <div class="container">
      <hr>
      <div class="row">
         <div class="col-xs-10">&copy; 2019 Hyunmin
            &middot; Powered by <a href="https://github.com/getpelican/pelican-themes/tree/master/pelican-bootstrap3" target="_blank">pelican-bootstrap3</a>,
            <a href="http://docs.getpelican.com/" target="_blank">Pelican</a>,
            <a href="http://getbootstrap.com" target="_blank">Bootstrap</a>         </div>
         <div class="col-xs-2"><p class="pull-right"><i class="fa fa-arrow-up"></i> <a href="#">Back to top</a></p></div>
      </div>
   </div>
</footer>
<script src="./theme/js/jquery.min.js"></script>

<!-- Include all compiled plugins (below), or include individual files as needed -->
<script src="./theme/js/bootstrap.min.js"></script>

<!-- Enable responsive features in IE8 with Respond.js (https://github.com/scottjehl/Respond) -->
<script src="./theme/js/respond.min.js"></script>


    <!-- Google Analytics -->
    <script type="text/javascript">

        var _gaq = _gaq || [];
        _gaq.push(['_setAccount', 'UA-91188832-2']);
        _gaq.push(['_trackPageview']);

        (function () {
            var ga = document.createElement('script');
            ga.type = 'text/javascript';
            ga.async = true;
            ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(ga, s);
        })();
    </script>
    <!-- End Google Analytics Code -->


</body>
</html>